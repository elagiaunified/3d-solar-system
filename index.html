<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solar System Explorer</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    .tooltip {
      transition: opacity 0.2s;
    }
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full relative overflow-hidden">
   <canvas id="spaceCanvas" class="absolute inset-0 w-full h-full"></canvas>
   <div class="absolute inset-0"><!-- Header -->
    <div class="p-6 pointer-events-auto">
     <h1 id="titleText" class="text-4xl font-bold mb-2">Solar System Explorer</h1>
     <p id="subtitleText" class="text-xl opacity-90">Complete Interactive 3D Solar System with Physics &amp; Educational Tools</p>
    </div><!-- Main Control Panel -->
    <div class="absolute top-6 right-6 p-4 rounded-lg pointer-events-auto max-w-xs" style="backdrop-filter: blur(10px);">
     <h3 class="text-sm font-bold mb-3 opacity-90">‚è±Ô∏è TIME CONTROLS</h3>
     <div class="space-y-2 mb-4">
      <div class="flex items-center justify-between"><span class="text-xs opacity-80">Speed:</span> <span id="speedDisplay" class="text-xs font-bold">1.0x</span>
      </div><input type="range" id="speedSlider" min="0" max="50" value="10" class="w-full">
      <div class="flex gap-2"><button id="pauseBtn" class="flex-1 px-3 py-1 rounded text-xs font-bold">‚è∏Ô∏è Pause</button> <button id="resetBtn" class="flex-1 px-3 py-1 rounded text-xs font-bold">‚Ü∫ Reset</button>
      </div>
     </div>
     <h3 class="text-sm font-bold mb-3 opacity-90 border-t border-current border-opacity-20 pt-3">üîß TOOLS</h3>
     <div class="space-y-2 mb-4"><button id="measureBtn" class="w-full px-3 py-1.5 rounded text-xs font-bold text-left">üìè Distance Measure</button> <button id="lagrangeBtn" class="w-full px-3 py-1.5 rounded text-xs font-bold text-left">üéØ Lagrange Points</button> <button id="habitableBtn" class="w-full px-3 py-1.5 rounded text-xs font-bold text-left">üå°Ô∏è Habitable Zone</button> <button id="gravityBtn" class="w-full px-3 py-1.5 rounded text-xs font-bold text-left">‚ö° Gravity Wells</button> <button id="quizBtn" class="w-full px-3 py-1.5 rounded text-xs font-bold text-left">üéì Quiz Challenge</button>
     </div>
     <h3 class="text-sm font-bold mb-2 opacity-90 border-t border-current border-opacity-20 pt-3">üéÆ CONTROLS</h3>
     <div class="space-y-1 text-xs opacity-80">
      <div>
       üñ±Ô∏è Drag to rotate
      </div>
      <div>
       üîç Scroll to zoom
      </div>
      <div>
       üñ±Ô∏è Click planets for info
      </div>
     </div>
    </div><!-- Info Panel -->
    <div id="infoPanel" class="absolute bottom-6 left-6 p-4 rounded-lg max-w-md pointer-events-auto opacity-0 transition-opacity duration-300" style="backdrop-filter: blur(10px); max-height: 70%; overflow-y: auto;">
     <div class="flex justify-between items-start mb-2">
      <h3 id="objectName" class="text-xl font-bold"></h3><button id="closeInfo" class="text-xl opacity-60 hover:opacity-100">√ó</button>
     </div>
     <p id="objectDescription" class="text-sm opacity-90 mb-3"></p>
     <div class="space-y-2 text-xs">
      <div class="p-2 rounded" style="background: rgba(255,255,255,0.05);">
       <div class="font-bold mb-1">
        üìä Orbital Data
       </div>
       <div class="opacity-80">
        <strong>Distance from Sun:</strong> <span id="distanceInfo"></span>
       </div>
       <div class="opacity-80">
        <strong>Orbital Period:</strong> <span id="periodInfo"></span>
       </div>
       <div class="opacity-80">
        <strong>Orbital Velocity:</strong> <span id="velocityInfo"></span>
       </div>
      </div>
      <div class="p-2 rounded" style="background: rgba(255,255,255,0.05);">
       <div class="font-bold mb-1">
        üåç Physical Properties
       </div>
       <div class="opacity-80">
        <strong>Diameter:</strong> <span id="sizeInfo"></span>
       </div>
       <div class="opacity-80">
        <strong>Mass:</strong> <span id="massInfo"></span>
       </div>
       <div class="opacity-80">
        <strong>Gravity:</strong> <span id="gravityInfo"></span>
       </div>
      </div>
      <div class="p-2 rounded" style="background: rgba(255,255,255,0.05);">
       <div class="font-bold mb-1">
        üî¨ Composition
       </div>
       <div class="opacity-80" id="compositionInfo"></div>
      </div>
      <div class="p-2 rounded" style="background: rgba(255,255,255,0.05);">
       <div class="font-bold mb-1">
        üöÄ Travel Time from Earth
       </div>
       <div class="opacity-80" id="travelInfo"></div>
      </div>
     </div>
    </div><!-- Measurement Display -->
    <div id="measureDisplay" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-3 rounded-lg pointer-events-none opacity-0 transition-opacity" style="backdrop-filter: blur(10px);">
     <div class="text-center">
      <div class="text-xs opacity-80 mb-1">
       Distance
      </div>
      <div id="measureValue" class="text-2xl font-bold"></div>
      <div class="text-xs opacity-80 mt-1">
       Click two objects to measure
      </div>
     </div>
    </div><!-- Quiz Modal -->
    <div id="quizModal" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity" style="background: rgba(0,0,0,0.7);">
     <div class="p-6 rounded-lg max-w-lg pointer-events-auto" style="backdrop-filter: blur(10px);">
      <div class="flex justify-between items-start mb-4">
       <h2 class="text-2xl font-bold">üéì Solar System Quiz</h2><button id="closeQuiz" class="text-2xl opacity-60 hover:opacity-100">√ó</button>
      </div>
      <div id="quizContent" class="space-y-4">
       <div class="text-lg mb-4" id="quizQuestion"></div>
       <div id="quizOptions" class="space-y-2"></div>
       <div id="quizFeedback" class="mt-4 p-3 rounded text-sm"></div>
       <div class="flex justify-between items-center mt-4">
        <div class="text-sm opacity-80">
         Score: <span id="quizScore">0</span>/5
        </div><button id="nextQuiz" class="px-4 py-2 rounded font-bold">Next Question</button>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
  const defaultConfig = {
  background_color: "#0A0E27",
  surface_color: "#1A1F3A",
  text_color: "#E8E8F0",
  primary_action_color: "#4A90E2",
  secondary_action_color: "#8B5CF6",
  font_family: "system-ui, -apple-system, sans-serif",
  font_size: 16,
  title_text: "Solar System Explorer",
  subtitle_text: "Complete Interactive 3D Solar System with Physics & Educational Tools"
};

let config = {};

const canvas = document.getElementById('spaceCanvas');
const ctx = canvas.getContext('2d');

let width, height, centerX, centerY;
let rotation = { x: 0, y: 0 };
let zoom = 0.8;
let isDragging = false;
let lastMouseX = 0;
let lastMouseY = 0;
let isPaused = false;
let timeSpeed = 1;
let time = 0;
let selectedObject = null;

// Tool states
let showLagrange = false;
let showHabitable = false;
let showGravity = false;
let measureMode = false;
let measurePoint1 = null;
let measurePoint2 = null;

// Quiz state
let quizActive = false;
let currentQuestion = 0;
let quizScore = 0;

const celestialBodies = {
  sun: {
    name: "Sun", radius: 30, color: ["#FFF9E6", "#FFD700"], distance: 0, period: 0,
    description: "The star at the center of our solar system, containing 99.86% of the system's mass.",
    distanceText: "0 AU", periodText: "N/A", velocity: "N/A",
    diameter: "1,391,000 km", mass: "1.989 √ó 10¬≥‚Å∞ kg", gravity: "274 m/s¬≤",
    composition: "73% Hydrogen, 25% Helium, 2% heavier elements",
    travel: "N/A - Too hot to approach!"
  },
  mercury: {
    name: "Mercury", radius: 6, color: ["#B8B8B8", "#8A8A8A"], distance: 80, period: 88, angle: 0,
    description: "Smallest planet and closest to the Sun. No atmosphere and extreme temperature variations.",
    distanceText: "0.39 AU (58M km)", periodText: "88 days", velocity: "47.4 km/s",
    diameter: "4,879 km", mass: "3.3 √ó 10¬≤¬≥ kg", gravity: "3.7 m/s¬≤",
    composition: "Rocky planet - Iron core (70%), Silicate mantle",
    travel: "~6-7 months with current technology"
  },
  venus: {
    name: "Venus", radius: 11, color: ["#FFC649", "#E8A030"], distance: 120, period: 225, angle: 1,
    description: "Hottest planet with a thick toxic atmosphere. Rotates backwards compared to most planets.",
    distanceText: "0.72 AU (108M km)", periodText: "225 days", velocity: "35.0 km/s",
    diameter: "12,104 km", mass: "4.87 √ó 10¬≤‚Å¥ kg", gravity: "8.9 m/s¬≤",
    composition: "Rocky - CO‚ÇÇ atmosphere (96.5%), Sulfuric acid clouds",
    travel: "~5 months with current technology"
  },
  earth: {
    name: "Earth", radius: 12, color: ["#6B9BD1", "#2E5C8A"], distance: 180, period: 365, angle: 2,
    description: "Our home planet. Only known world with life. 71% covered by water with nitrogen-oxygen atmosphere.",
    distanceText: "1.0 AU (150M km)", periodText: "365.25 days", velocity: "29.8 km/s",
    diameter: "12,742 km", mass: "5.97 √ó 10¬≤‚Å¥ kg", gravity: "9.8 m/s¬≤",
    composition: "Rocky - N‚ÇÇ/O‚ÇÇ atmosphere, liquid water, iron/nickel core",
    travel: "You're already here! üåç"
  },
  moon: {
    name: "Moon", radius: 4, color: ["#C8C8C8", "#8A8A8A"], distance: 25, period: 27.3, angle: 0, parent: "earth",
    description: "Earth's only natural satellite. Influences tides and stabilizes Earth's axial tilt.",
    distanceText: "384,400 km from Earth", periodText: "27.3 days", velocity: "1.0 km/s",
    diameter: "3,474 km", mass: "7.35 √ó 10¬≤¬≤ kg", gravity: "1.6 m/s¬≤",
    composition: "Rocky - No atmosphere, ancient volcanic maria",
    travel: "~3 days (Apollo missions took 3 days)"
  },
  mars: {
    name: "Mars", radius: 9, color: ["#E27B58", "#C1440E"], distance: 240, period: 687, angle: 3,
    description: "The Red Planet with the largest volcano and canyon in the solar system. Prime candidate for colonization.",
    distanceText: "1.52 AU (228M km)", periodText: "687 days", velocity: "24.1 km/s",
    diameter: "6,779 km", mass: "6.42 √ó 10¬≤¬≥ kg", gravity: "3.7 m/s¬≤",
    composition: "Rocky - Thin CO‚ÇÇ atmosphere, iron oxide surface, polar ice caps",
    travel: "~7-9 months with current technology"
  },
  jupiter: {
    name: "Jupiter", radius: 24, color: ["#E8B882", "#C4935B"], distance: 350, period: 4333, angle: 4,
    description: "Largest planet with a mass greater than all other planets combined. Famous Great Red Spot storm.",
    distanceText: "5.2 AU (778M km)", periodText: "11.9 years", velocity: "13.1 km/s",
    diameter: "139,820 km", mass: "1.90 √ó 10¬≤‚Å∑ kg", gravity: "24.8 m/s¬≤",
    composition: "Gas giant - 90% H‚ÇÇ, 10% He. No solid surface",
    travel: "~13 months to 2 years (Voyager: 18 months)"
  },
  saturn: {
    name: "Saturn", radius: 20, color: ["#F4E8C1", "#D4C18A"], distance: 480, period: 10759, angle: 5,
    description: "Famous for its spectacular ring system made of ice and rock. Least dense planet - would float in water!",
    distanceText: "9.5 AU (1.4B km)", periodText: "29.5 years", velocity: "9.7 km/s",
    diameter: "116,460 km", mass: "5.68 √ó 10¬≤‚Å∂ kg", gravity: "10.4 m/s¬≤",
    composition: "Gas giant - H‚ÇÇ/He with magnificent ring system",
    travel: "~3-4 years (Cassini: 7 years)"
  },
  uranus: {
    name: "Uranus", radius: 16, color: ["#A4D4E6", "#7FB3C8"], distance: 580, period: 30687, angle: 0,
    description: "Ice giant that rotates on its side! Coldest planetary atmosphere in the solar system.",
    distanceText: "19.2 AU (2.9B km)", periodText: "84 years", velocity: "6.8 km/s",
    diameter: "50,724 km", mass: "8.68 √ó 10¬≤‚Åµ kg", gravity: "8.9 m/s¬≤",
    composition: "Ice giant - H‚ÇÇ/He/CH‚ÇÑ atmosphere, icy mantle",
    travel: "~8-9 years (Voyager 2: 8.5 years)"
  },
  neptune: {
    name: "Neptune", radius: 15, color: ["#5E7FCF", "#4A5FAD"], distance: 660, period: 60190, angle: 1.5,
    description: "Furthest planet with the strongest winds in the solar system, up to 2,100 km/h!",
    distanceText: "30.1 AU (4.5B km)", periodText: "165 years", velocity: "5.4 km/s",
    diameter: "49,244 km", mass: "1.02 √ó 10¬≤‚Å∂ kg", gravity: "11.2 m/s¬≤",
    composition: "Ice giant - H‚ÇÇ/He/CH‚ÇÑ atmosphere, supersonic winds",
    travel: "~12 years (Voyager 2: 12 years)"
  }
};

const quizQuestions = [
  {
    q: "Which planet has the strongest gravity?",
    options: ["Earth", "Jupiter", "Saturn", "Neptune"],
    correct: 1,
    explanation: "Jupiter has the strongest gravity at 24.8 m/s¬≤, over 2.5 times Earth's gravity!"
  },
  {
    q: "Which planet could theoretically float in water?",
    options: ["Mars", "Saturn", "Uranus", "Venus"],
    correct: 1,
    explanation: "Saturn is the least dense planet and would float if you could find a bathtub big enough!"
  },
  {
    q: "How long does it take light from the Sun to reach Earth?",
    options: ["8 seconds", "8 minutes", "8 hours", "8 days"],
    correct: 1,
    explanation: "Light takes about 8 minutes and 20 seconds to travel from the Sun to Earth (1 AU)."
  },
  {
    q: "Which planet has the longest day (rotation period)?",
    options: ["Mercury", "Venus", "Jupiter", "Neptune"],
    correct: 1,
    explanation: "Venus takes 243 Earth days to rotate once, longer than its year of 225 days!"
  },
  {
    q: "What is the habitable zone also known as?",
    options: ["Safe zone", "Goldilocks zone", "Life zone", "Green zone"],
    correct: 1,
    explanation: "The habitable zone is called the 'Goldilocks zone' - not too hot, not too cold, just right for liquid water!"
  }
];

function resizeCanvas() {
  width = canvas.width = canvas.offsetWidth;
  height = canvas.height = canvas.offsetHeight;
  centerX = width / 2;
  centerY = height / 2;
}

function drawSphere(x, y, radius, colors, showGlow = true) {
  if (showGlow) {
    const gradient = ctx.createRadialGradient(
      x - radius * 0.3, y - radius * 0.3, 0,
      x, y, radius
    );
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(1, colors[1]);
    ctx.fillStyle = gradient;
  } else {
    ctx.fillStyle = colors[1];
  }
  
  ctx.beginPath();
  ctx.arc(x, y, radius * zoom, 0, Math.PI * 2);
  ctx.fill();
  
  if (showGlow) {
    ctx.strokeStyle = colors[0] + "40";
    ctx.lineWidth = 1;
    ctx.stroke();
  }
}

function drawOrbit(distance, highlight = false) {
  const textColor = config.text_color || defaultConfig.text_color;
  ctx.strokeStyle = highlight ? textColor + "60" : textColor + "20";
  ctx.lineWidth = highlight ? 2 : 1;
  ctx.setLineDash(highlight ? [10, 5] : [5, 5]);
  ctx.beginPath();
  ctx.arc(centerX, centerY, distance * zoom, 0, Math.PI * 2);
  ctx.stroke();
  ctx.setLineDash([]);
}

function drawHabitableZone() {
  const inner = 140 * zoom;
  const outer = 220 * zoom;
  
  const gradient = ctx.createRadialGradient(centerX, centerY, inner, centerX, centerY, outer);
  gradient.addColorStop(0, 'rgba(50, 205, 50, 0.1)');
  gradient.addColorStop(0.5, 'rgba(50, 205, 50, 0.2)');
  gradient.addColorStop(1, 'rgba(50, 205, 50, 0.1)');
  
  ctx.fillStyle = gradient;
  ctx.beginPath();
  ctx.arc(centerX, centerY, outer, 0, Math.PI * 2);
  ctx.arc(centerX, centerY, inner, 0, Math.PI * 2, true);
  ctx.fill();
  
  ctx.strokeStyle = 'rgba(50, 205, 50, 0.6)';
  ctx.lineWidth = 2;
  ctx.setLineDash([10, 5]);
  ctx.beginPath();
  ctx.arc(centerX, centerY, inner, 0, Math.PI * 2);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(centerX, centerY, outer, 0, Math.PI * 2);
  ctx.stroke();
  ctx.setLineDash([]);
  
  ctx.fillStyle = 'rgba(50, 205, 50, 0.9)';
  ctx.font = '12px system-ui';
  ctx.fillText('Habitable Zone', centerX - 50, centerY - outer - 10);
}

function drawGravityWells() {
  Object.entries(celestialBodies).forEach(([key, body]) => {
    if (body.name === 'Moon') return;
    
    const pos = getPosition(body);
    const gravityRadius = Math.log(body.radius + 1) * 30;
    
    const gradient = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, gravityRadius * zoom);
    gradient.addColorStop(0, body.color[1] + '40');
    gradient.addColorStop(0.5, body.color[1] + '20');
    gradient.addColorStop(1, body.color[1] + '00');
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, gravityRadius * zoom, 0, Math.PI * 2);
    ctx.fill();
  });
}

function drawLagrangePoints() {
  const earth = celestialBodies.earth;
  const earthPos = getPosition(earth);
  const sunPos = { x: centerX, y: centerY };
  
  const dx = earthPos.x - sunPos.x;
  const dy = earthPos.y - sunPos.y;
  const dist = Math.sqrt(dx * dx + dy * dy);
  const angle = Math.atan2(dy, dx);
  
  const l1Dist = dist * 0.99;
  const l2Dist = dist * 1.01;
  const l3Dist = dist;
  
  const points = [
    { x: sunPos.x + Math.cos(angle) * l1Dist, y: sunPos.y + Math.sin(angle) * l1Dist, label: 'L1' },
    { x: sunPos.x + Math.cos(angle) * l2Dist, y: sunPos.y + Math.sin(angle) * l2Dist, label: 'L2' },
    { x: sunPos.x - Math.cos(angle) * l3Dist, y: sunPos.y - Math.sin(angle) * l3Dist, label: 'L3' },
    { x: sunPos.x + Math.cos(angle + Math.PI/3) * dist, y: sunPos.y + Math.sin(angle + Math.PI/3) * dist, label: 'L4' },
    { x: sunPos.x + Math.cos(angle - Math.PI/3) * dist, y: sunPos.y + Math.sin(angle - Math.PI/3) * dist, label: 'L5' }
  ];
  
  const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
  points.forEach(point => {
    ctx.fillStyle = primaryColor;
    ctx.beginPath();
    ctx.arc(point.x, point.y, 4, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = config.text_color || defaultConfig.text_color;
    ctx.font = 'bold 11px system-ui';
    ctx.fillText(point.label, point.x + 8, point.y - 8);
  });
}

function getPosition(body) {
  if (body.parent) {
    const parent = celestialBodies[body.parent];
    const parentPos = getPosition(parent);
    const angle = body.angle + rotation.y;
    return {
      x: parentPos.x + Math.cos(angle) * body.distance * zoom,
      y: parentPos.y + Math.sin(angle) * body.distance * zoom
    };
  }
  const angle = body.angle + rotation.y;
  return {
    x: centerX + Math.cos(angle) * body.distance * zoom,
    y: centerY + Math.sin(angle) * body.distance * zoom
  };
}

function isPointInCircle(px, py, cx, cy, radius) {
  const dx = px - cx;
  const dy = py - cy;
  return dx * dx + dy * dy <= radius * radius;
}

function findObjectAtPoint(x, y) {
  for (const [key, body] of Object.entries(celestialBodies)) {
    const pos = getPosition(body);
    if (isPointInCircle(x, y, pos.x, pos.y, body.radius * zoom)) {
      return key;
    }
  }
  return null;
}

function updateSelection(key) {
  if (key !== selectedObject) {
    selectedObject = key;
    const panel = document.getElementById('infoPanel');
    
    if (selectedObject) {
      const body = celestialBodies[selectedObject];
      document.getElementById('objectName').textContent = body.name;
      document.getElementById('objectDescription').textContent = body.description;
      document.getElementById('distanceInfo').textContent = body.distanceText;
      document.getElementById('periodInfo').textContent = body.periodText;
      document.getElementById('velocityInfo').textContent = body.velocity;
      document.getElementById('sizeInfo').textContent = body.diameter;
      document.getElementById('massInfo').textContent = body.mass;
      document.getElementById('gravityInfo').textContent = body.gravity;
      document.getElementById('compositionInfo').textContent = body.composition;
      document.getElementById('travelInfo').textContent = body.travel;
      panel.style.opacity = '1';
    } else {
      panel.style.opacity = '0';
    }
  }
}

function calculateDistance(obj1, obj2) {
  const pos1 = getPosition(celestialBodies[obj1]);
  const pos2 = getPosition(celestialBodies[obj2]);
  const dx = pos2.x - pos1.x;
  const dy = pos2.y - pos1.y;
  const pixelDist = Math.sqrt(dx * dx + dy * dy);
  
  const dist1 = celestialBodies[obj1].distance;
  const dist2 = celestialBodies[obj2].distance;
  const actualDist = Math.abs(dist2 - dist1);
  const au = actualDist / 180;
  
  return { pixels: pixelDist, au: au.toFixed(2), km: (au * 150).toFixed(0) };
}

function render() {
  const bgColor = config.background_color || defaultConfig.background_color;
  ctx.fillStyle = bgColor;
  ctx.fillRect(0, 0, width, height);
  
  if (showHabitable) {
    drawHabitableZone();
  }
  
  if (showGravity) {
    drawGravityWells();
  }
  
  Object.entries(celestialBodies).forEach(([key, body]) => {
    if (body.distance > 0 && !body.parent) {
      drawOrbit(body.distance, key === selectedObject);
    }
  });
  
  if (celestialBodies.moon) {
    const earthPos = getPosition(celestialBodies.earth);
    ctx.strokeStyle = (config.text_color || defaultConfig.text_color) + "15";
    ctx.lineWidth = 1;
    ctx.setLineDash([3, 3]);
    ctx.beginPath();
    ctx.arc(earthPos.x, earthPos.y, celestialBodies.moon.distance * zoom, 0, Math.PI * 2);
    ctx.stroke();
    ctx.setLineDash([]);
  }
  
  if (showLagrange) {
    drawLagrangePoints();
  }
  
  ctx.shadowBlur = 30;
  ctx.shadowColor = "#FFD70080";
  drawSphere(centerX, centerY, celestialBodies.sun.radius, celestialBodies.sun.color);
  
  Object.entries(celestialBodies).forEach(([key, body]) => {
    if (body.name !== 'Sun') {
      const pos = getPosition(body);
      ctx.shadowBlur = 15;
      ctx.shadowColor = body.color[1] + "40";
      drawSphere(pos.x, pos.y, body.radius, body.color);
      
      if (key === selectedObject) {
        ctx.strokeStyle = config.primary_action_color || defaultConfig.primary_action_color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, (body.radius + 3) * zoom, 0, Math.PI * 2);
        ctx.stroke();
      }
    }
  });
  
  if (measureMode && measurePoint1) {
    const pos1 = getPosition(celestialBodies[measurePoint1]);
    ctx.strokeStyle = config.secondary_action_color || defaultConfig.secondary_action_color;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(pos1.x, pos1.y, 8, 0, Math.PI * 2);
    ctx.stroke();
    
    if (measurePoint2) {
      const pos2 = getPosition(celestialBodies[measurePoint2]);
      ctx.beginPath();
      ctx.moveTo(pos1.x, pos1.y);
      ctx.lineTo(pos2.x, pos2.y);
      ctx.stroke();
      
      ctx.beginPath();
      ctx.arc(pos2.x, pos2.y, 8, 0, Math.PI * 2);
      ctx.stroke();
    }
  }
  
  ctx.shadowBlur = 0;
}

function animate() {
  if (!isPaused) {
    time += 0.0005 * timeSpeed;
    
    Object.entries(celestialBodies).forEach(([key, body]) => {
      if (body.period > 0 && !body.parent) {
        body.angle = time * (2 * Math.PI / body.period) * 100;
      } else if (body.parent) {
        body.angle = time * (2 * Math.PI / body.period) * 100;
      }
    });
  }
  
  render();
  requestAnimationFrame(animate);
}

function loadQuizQuestion() {
  if (currentQuestion >= quizQuestions.length) {
    document.getElementById('quizContent').innerHTML = `
      <div class="text-center">
        <div class="text-4xl mb-4">üéâ</div>
        <div class="text-2xl font-bold mb-2">Quiz Complete!</div>
        <div class="text-lg mb-4">Final Score: ${quizScore}/${quizQuestions.length}</div>
        <button id="restartQuiz" class="px-6 py-3 rounded font-bold">Start New Quiz</button>
      </div>
    `;
    
    const restartBtn = document.getElementById('restartQuiz');
    restartBtn.style.background = config.primary_action_color || defaultConfig.primary_action_color;
    restartBtn.style.color = config.text_color || defaultConfig.text_color;
    restartBtn.onclick = () => {
      currentQuestion = 0;
      quizScore = 0;
      loadQuizQuestion();
    };
    return;
  }
  
  const q = quizQuestions[currentQuestion];
  document.getElementById('quizQuestion').textContent = q.q;
  document.getElementById('quizScore').textContent = `${quizScore}/${quizQuestions.length}`;
  document.getElementById('quizFeedback').style.display = 'none';
  
  const optionsDiv = document.getElementById('quizOptions');
  optionsDiv.innerHTML = '';
  
  q.options.forEach((option, idx) => {
    const btn = document.createElement('button');
    btn.textContent = option;
    btn.className = 'w-full px-4 py-3 rounded text-left font-semibold transition-all';
    btn.style.background = config.surface_color || defaultConfig.surface_color;
    btn.style.color = config.text_color || defaultConfig.text_color;
    btn.style.border = '2px solid transparent';
    
    btn.onmouseenter = () => {
      btn.style.borderColor = config.primary_action_color || defaultConfig.primary_action_color;
    };
    btn.onmouseleave = () => {
      btn.style.borderColor = 'transparent';
    };
    
    btn.onclick = () => {
      const feedback = document.getElementById('quizFeedback');
      if (idx === q.correct) {
        feedback.style.background = 'rgba(50, 205, 50, 0.2)';
        feedback.innerHTML = `<div class="font-bold mb-1">‚úì Correct!</div><div>${q.explanation}</div>`;
        quizScore++;
        document.getElementById('quizScore').textContent = `${quizScore}/${quizQuestions.length}`;
      } else {
        feedback.style.background = 'rgba(220, 50, 50, 0.2)';
        feedback.innerHTML = `<div class="font-bold mb-1">‚úó Not quite!</div><div>${q.explanation}</div>`;
      }
      feedback.style.display = 'block';
      
      Array.from(optionsDiv.children).forEach(b => b.disabled = true);
    };
    
    optionsDiv.appendChild(btn);
  });
  
  const nextBtn = document.getElementById('nextQuiz');
  nextBtn.style.background = config.primary_action_color || defaultConfig.primary_action_color;
  nextBtn.style.color = config.text_color || defaultConfig.text_color;
}

// Event Listeners
canvas.addEventListener('mousedown', (e) => {
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  
  const clickedObj = findObjectAtPoint(mouseX, mouseY);
  
  if (measureMode && clickedObj) {
    if (!measurePoint1) {
      measurePoint1 = clickedObj;
    } else if (!measurePoint2) {
      measurePoint2 = clickedObj;
      const dist = calculateDistance(measurePoint1, measurePoint2);
      document.getElementById('measureValue').innerHTML = 
        `${dist.au} AU<br><span style="font-size: 14px;">(${dist.km}M km)</span>`;
      document.getElementById('measureDisplay').style.opacity = '1';
    } else {
      measurePoint1 = clickedObj;
      measurePoint2 = null;
      document.getElementById('measureDisplay').style.opacity = '0';
    }
  } else {
    updateSelection(clickedObj);
    isDragging = true;
    lastMouseX = e.clientX;
    lastMouseY = e.clientY;
  }
});

canvas.addEventListener('mousemove', (e) => {
  if (isDragging) {
    const deltaX = e.clientX - lastMouseX;
    const deltaY = e.clientY - lastMouseY;
    
    rotation.y += deltaX * 0.01;
    rotation.x += deltaY * 0.01;
    
    lastMouseX = e.clientX;
    lastMouseY = e.clientY;
  }
});

canvas.addEventListener('mouseup', () => {
  isDragging = false;
});

canvas.addEventListener('wheel', (e) => {
  e.preventDefault();
  const zoomSpeed = 0.001;
  zoom += e.deltaY * -zoomSpeed;
  zoom = Math.max(0.2, Math.min(2, zoom));
});

document.getElementById('speedSlider').addEventListener('input', (e) => {
  timeSpeed = parseFloat(e.target.value) / 10;
  document.getElementById('speedDisplay').textContent = timeSpeed.toFixed(1) + 'x';
});

document.getElementById('pauseBtn').addEventListener('click', () => {
  isPaused = !isPaused;
  document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
});

document.getElementById('resetBtn').addEventListener('click', () => {
  time = 0;
  rotation = { x: 0, y: 0 };
  zoom = 0.8;
  Object.entries(celestialBodies).forEach(([key, body]) => {
    if (body.period > 0) body.angle = key === 'mercury' ? 0 : parseFloat(key.charCodeAt(0)) / 20;
  });
});

// Initialize tool button styles
function initToolButtons() {
  const surfaceColor = config.surface_color || defaultConfig.surface_color;
  const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
  
  // Reset all tool buttons to surface color
  document.getElementById('measureBtn').style.background = measureMode ? primaryColor : surfaceColor;
  document.getElementById('lagrangeBtn').style.background = showLagrange ? primaryColor : surfaceColor;
  document.getElementById('habitableBtn').style.background = showHabitable ? primaryColor : surfaceColor;
  document.getElementById('gravityBtn').style.background = showGravity ? primaryColor : surfaceColor;
}

document.getElementById('measureBtn').addEventListener('click', () => {
  measureMode = !measureMode;
  if (!measureMode) {
    measurePoint1 = null;
    measurePoint2 = null;
    document.getElementById('measureDisplay').style.opacity = '0';
  }
  initToolButtons();
});

document.getElementById('lagrangeBtn').addEventListener('click', () => {
  showLagrange = !showLagrange;
  initToolButtons();
});

document.getElementById('habitableBtn').addEventListener('click', () => {
  showHabitable = !showHabitable;
  initToolButtons();
});

document.getElementById('gravityBtn').addEventListener('click', () => {
  showGravity = !showGravity;
  initToolButtons();
});

document.getElementById('quizBtn').addEventListener('click', () => {
  document.getElementById('quizModal').style.opacity = '1';
  document.getElementById('quizModal').style.pointerEvents = 'auto';
  if (currentQuestion === 0 && quizScore === 0) {
    loadQuizQuestion();
  }
});

document.getElementById('closeQuiz').addEventListener('click', () => {
  document.getElementById('quizModal').style.opacity = '0';
  document.getElementById('quizModal').style.pointerEvents = 'none';
});

document.getElementById('nextQuiz').addEventListener('click', () => {
  currentQuestion++;
  loadQuizQuestion();
});

document.getElementById('closeInfo').addEventListener('click', () => {
  selectedObject = null;
  document.getElementById('infoPanel').style.opacity = '0';
});

async function onConfigChange(newConfig) {
  config = newConfig;
  
  const bgColor = config.background_color || defaultConfig.background_color;
  const surfaceColor = config.surface_color || defaultConfig.surface_color;
  const textColor = config.text_color || defaultConfig.text_color;
  const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
  const fontFamily = config.font_family || defaultConfig.font_family;
  const fontSize = config.font_size || defaultConfig.font_size;
  
  document.body.style.background = bgColor;
  document.body.style.color = textColor;
  document.body.style.fontFamily = `${fontFamily}, system-ui, -apple-system, sans-serif`;
  
  const overlays = document.querySelectorAll('[style*="backdrop-filter"]');
  overlays.forEach(el => {
    el.style.background = surfaceColor + 'CC';
    el.style.color = textColor;
  });
  
  document.getElementById('titleText').textContent = config.title_text || defaultConfig.title_text;
  document.getElementById('titleText').style.fontSize = `${fontSize * 2.5}px`;
  
  document.getElementById('subtitleText').textContent = config.subtitle_text || defaultConfig.subtitle_text;
  document.getElementById('subtitleText').style.fontSize = `${fontSize * 1.25}px`;
  
  const buttons = document.querySelectorAll('button');
  buttons.forEach(btn => {
    if (!btn.id.includes('measure') && !btn.id.includes('lagrange') && 
        !btn.id.includes('habitable') && !btn.id.includes('gravity')) {
      btn.style.background = primaryColor;
      btn.style.color = textColor;
    }
  });
  
  initToolButtons();
}

function mapToCapabilities(config) {
  return {
    recolorables: [
      {
        get: () => config.background_color || defaultConfig.background_color,
        set: (value) => {
          config.background_color = value;
          window.elementSdk.setConfig({ background_color: value });
        }
      },
      {
        get: () => config.surface_color || defaultConfig.surface_color,
        set: (value) => {
          config.surface_color = value;
          window.elementSdk.setConfig({ surface_color: value });
        }
      },
      {
        get: () => config.text_color || defaultConfig.text_color,
        set: (value) => {
          config.text_color = value;
          window.elementSdk.setConfig({ text_color: value });
        }
      },
      {
        get: () => config.primary_action_color || defaultConfig.primary_action_color,
        set: (value) => {
          config.primary_action_color = value;
          window.elementSdk.setConfig({ primary_action_color: value });
        }
      },
      {
        get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
        set: (value) => {
          config.secondary_action_color = value;
          window.elementSdk.setConfig({ secondary_action_color: value });
        }
      }
    ],
    borderables: [],
    fontEditable: {
      get: () => config.font_family || defaultConfig.font_family,
      set: (value) => {
        config.font_family = value;
        window.elementSdk.setConfig({ font_family: value });
      }
    },
    fontSizeable: {
      get: () => config.font_size || defaultConfig.font_size,
      set: (value) => {
        config.font_size = value;
        window.elementSdk.setConfig({ font_size: value });
      }
    }
  };
}

function mapToEditPanelValues(config) {
  return new Map([
    ["title_text", config.title_text || defaultConfig.title_text],
    ["subtitle_text", config.subtitle_text || defaultConfig.subtitle_text]
  ]);
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

if (window.elementSdk) {
  window.elementSdk.init({
    defaultConfig,
    onConfigChange,
    mapToCapabilities,
    mapToEditPanelValues
  });
  
  config = window.elementSdk.config;
  onConfigChange(config);
} else {
  config = defaultConfig;
  onConfigChange(config);
}

animate();
  </script>
